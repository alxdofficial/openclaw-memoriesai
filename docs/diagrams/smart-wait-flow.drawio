<mxfile host="app.diagrams.net" modified="2026-02-14T08:35:00.000Z" agent="openclaw-memoriesai" version="24.0.0" type="device">
  <diagram id="smart-wait-flow" name="Smart Wait Flow">
    <mxGraphModel dx="1422" dy="900" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1400" pageHeight="1100" math="0" shadow="0">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>

        <mxCell id="title" value="Smart Wait â€” Tool Call Flow" style="text;html=1;fontSize=20;fontStyle=1;align=center;fillColor=none;strokeColor=none;fontColor=#1a1a2e;" vertex="1" parent="1">
          <mxGeometry x="350" y="20" width="500" height="40" as="geometry"/>
        </mxCell>

        <!-- START -->
        <mxCell id="start" value="Agent calls&lt;br&gt;&lt;b&gt;smart_wait&lt;/b&gt;(target, wake_when, timeout)" style="shape=hexagon;perimeter=hexagonPerimeter2;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=12;shadow=1;size=auto;" vertex="1" parent="1">
          <mxGeometry x="440" y="80" width="320" height="60" as="geometry"/>
        </mxCell>

        <!-- MCP Proxy -->
        <mxCell id="proxy" value="MCP Proxy forwards&lt;br&gt;to daemon HTTP :18790" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=11;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="480" y="180" width="240" height="50" as="geometry"/>
        </mxCell>
        <mxCell id="e1" style="rounded=1;strokeWidth=2;strokeColor=#6c8ebf;" edge="1" parent="1" source="start" target="proxy"><mxGeometry relative="1" as="geometry"/></mxCell>

        <!-- Add to queue -->
        <mxCell id="queue" value="WaitEngine adds job&lt;br&gt;to async priority queue" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="480" y="270" width="240" height="50" as="geometry"/>
        </mxCell>
        <mxCell id="e2" style="rounded=1;strokeWidth=2;strokeColor=#b85450;" edge="1" parent="1" source="proxy" target="queue"><mxGeometry relative="1" as="geometry"/></mxCell>

        <!-- Return immediately -->
        <mxCell id="return" value="Returns job_id immediately&lt;br&gt;&lt;font color=&quot;#666&quot;&gt;(agent is free to do other work)&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=11;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="120" y="270" width="260" height="50" as="geometry"/>
        </mxCell>
        <mxCell id="e2b" style="rounded=1;strokeWidth=1;strokeColor=#82b366;dashed=1;" edge="1" parent="1" source="queue" target="return"><mxGeometry relative="1" as="geometry"/></mxCell>

        <!-- Poll loop -->
        <mxCell id="poll" value="&lt;b&gt;Adaptive Poll Loop&lt;/b&gt;&lt;br&gt;(runs in background)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=12;fontStyle=0;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="480" y="370" width="240" height="50" as="geometry"/>
        </mxCell>
        <mxCell id="e3" style="rounded=1;strokeWidth=2;strokeColor=#82b366;" edge="1" parent="1" source="queue" target="poll"><mxGeometry relative="1" as="geometry"/></mxCell>

        <!-- Target check -->
        <mxCell id="target-check" value="target?" style="rhombus;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=12;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="530" y="470" width="140" height="80" as="geometry"/>
        </mxCell>
        <mxCell id="e4" style="rounded=1;strokeWidth=2;strokeColor=#82b366;" edge="1" parent="1" source="poll" target="target-check"><mxGeometry relative="1" as="geometry"/></mxCell>

        <!-- PTY path -->
        <mxCell id="pty-regex" value="&lt;b&gt;PTY Fast Path&lt;/b&gt;&lt;br&gt;Read terminal buffer&lt;br&gt;Match regex patterns&lt;br&gt;&lt;font color=&quot;#666&quot;&gt;(npm, git, pip, make...)&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=11;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="180" y="470" width="220" height="80" as="geometry"/>
        </mxCell>
        <mxCell id="e5a" value="pty" style="rounded=1;strokeWidth=2;strokeColor=#d79b00;fontStyle=1;fontSize=11;" edge="1" parent="1" source="target-check" target="pty-regex"><mxGeometry relative="1" as="geometry"/></mxCell>

        <!-- Screen path -->
        <mxCell id="capture" value="&lt;b&gt;Capture Screen&lt;/b&gt;&lt;br&gt;python-xlib â†’ Xvfb :99&lt;br&gt;&lt;font color=&quot;#666&quot;&gt;1920Ã—1080 screenshot&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=11;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="800" y="470" width="220" height="80" as="geometry"/>
        </mxCell>
        <mxCell id="e5b" value="screen" style="rounded=1;strokeWidth=2;strokeColor=#9673a6;fontStyle=1;fontSize=11;" edge="1" parent="1" source="target-check" target="capture"><mxGeometry relative="1" as="geometry"/></mxCell>

        <!-- Diff gate -->
        <mxCell id="diffgate" value="Pixel-diff gate&lt;br&gt;&lt;b&gt;changed â‰¥ threshold?&lt;/b&gt;" style="rhombus;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=11;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="830" y="600" width="170" height="90" as="geometry"/>
        </mxCell>
        <mxCell id="e6" style="rounded=1;strokeWidth=2;strokeColor=#9673a6;" edge="1" parent="1" source="capture" target="diffgate"><mxGeometry relative="1" as="geometry"/></mxCell>

        <!-- No change - skip -->
        <mxCell id="skip" value="Skip vision eval&lt;br&gt;&lt;font color=&quot;#666&quot;&gt;(save GPU, wait next poll)&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#999;fontSize=10;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1080" y="610" width="180" height="50" as="geometry"/>
        </mxCell>
        <mxCell id="e7a" value="No" style="rounded=1;strokeWidth=1;strokeColor=#999;fontStyle=1;fontSize=11;fontColor=#999;" edge="1" parent="1" source="diffgate" target="skip"><mxGeometry relative="1" as="geometry"/></mxCell>

        <!-- Back to poll from skip -->
        <mxCell id="skip-back" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeWidth=1;strokeColor=#999;dashed=1;" edge="1" parent="1" source="skip" target="poll">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1170" y="395"/>
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- Vision eval -->
        <mxCell id="vision" value="&lt;b&gt;MiniCPM-o Vision Eval&lt;/b&gt;&lt;br&gt;Send frame + wake_when prompt&lt;br&gt;â†’ Ollama :11434&lt;br&gt;&lt;font color=&quot;#666&quot;&gt;Returns YES / NO / PARTIAL&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=11;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="780" y="740" width="260" height="80" as="geometry"/>
        </mxCell>
        <mxCell id="e7b" value="Yes" style="rounded=1;strokeWidth=2;strokeColor=#9673a6;fontStyle=1;fontSize=11;" edge="1" parent="1" source="diffgate" target="vision"><mxGeometry relative="1" as="geometry"/></mxCell>

        <!-- Verdict -->
        <mxCell id="verdict" value="Verdict?" style="rhombus;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=12;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="520" y="750" width="140" height="80" as="geometry"/>
        </mxCell>
        <mxCell id="e8" style="rounded=1;strokeWidth=2;strokeColor=#9673a6;" edge="1" parent="1" source="vision" target="verdict"><mxGeometry relative="1" as="geometry"/></mxCell>

        <!-- PTY match check -->
        <mxCell id="pty-match" value="Regex&lt;br&gt;matched?" style="rhombus;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=11;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="220" y="600" width="130" height="80" as="geometry"/>
        </mxCell>
        <mxCell id="e5c" style="rounded=1;strokeWidth=2;strokeColor=#d79b00;" edge="1" parent="1" source="pty-regex" target="pty-match"><mxGeometry relative="1" as="geometry"/></mxCell>

        <!-- PTY no match -> vision fallback -->
        <mxCell id="pty-fallback" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeWidth=1;strokeColor=#999;dashed=1;" edge="1" parent="1" source="pty-match" target="capture">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="160" y="640"/>
              <mxPoint x="160" y="430"/>
              <mxPoint x="910" y="430"/>
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="pty-fallback-label" value="No â†’ vision fallback" style="edgeLabel;html=1;fontSize=10;fontColor=#999;" vertex="1" connectable="0" parent="pty-fallback">
          <mxGeometry x="0.3" relative="1" as="geometry"><mxPoint as="offset"/></mxGeometry>
        </mxCell>

        <!-- PTY match -> resolved -->
        <mxCell id="pty-resolved" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeWidth=2;strokeColor=#d79b00;" edge="1" parent="1" source="pty-match" target="verdict">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="285" y="790"/>
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="pty-resolved-label" value="Yes â†’ RESOLVED" style="edgeLabel;html=1;fontSize=10;fontColor=#d79b00;fontStyle=1;" vertex="1" connectable="0" parent="pty-resolved">
          <mxGeometry relative="1" as="geometry"><mxPoint as="offset"/></mxGeometry>
        </mxCell>

        <!-- NO/PARTIAL -> back to poll -->
        <mxCell id="verdict-no" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeWidth=1;strokeColor=#999;dashed=1;" edge="1" parent="1" source="verdict" target="poll">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="440" y="790"/>
              <mxPoint x="440" y="395"/>
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="verdict-no-label" value="NO / PARTIAL&lt;br&gt;â†’ next poll" style="edgeLabel;html=1;fontSize=10;fontColor=#999;" vertex="1" connectable="0" parent="verdict-no">
          <mxGeometry relative="1" as="geometry"><mxPoint as="offset"/></mxGeometry>
        </mxCell>

        <!-- YES -> Wake -->
        <mxCell id="wake" value="&lt;b&gt;ðŸ”´ WAKE AGENT&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:11px&quot;&gt;openclaw system event&lt;br&gt;--text &quot;wait resolved: ...&quot;&lt;br&gt;--mode now&lt;/font&gt;" style="shape=hexagon;perimeter=hexagonPerimeter2;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=12;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="480" y="880" width="260" height="80" as="geometry"/>
        </mxCell>
        <mxCell id="e9" value="YES / TIMEOUT" style="rounded=1;strokeWidth=2;strokeColor=#cc0000;fontStyle=1;fontSize=11;fontColor=#cc0000;" edge="1" parent="1" source="verdict" target="wake"><mxGeometry relative="1" as="geometry"/></mxCell>

        <!-- Legend -->
        <mxCell id="legend" value="&lt;b&gt;Legend&lt;/b&gt;&lt;br&gt;ðŸŸ¦ Agent layer&lt;br&gt;ðŸŸ§ PTY fast path (ms)&lt;br&gt;ðŸŸª Screen + vision path (2-5s)&lt;br&gt;ðŸ”´ Wake = system event injection" style="text;html=1;fontSize=11;align=left;verticalAlign=top;fillColor=#f5f5f5;strokeColor=#ccc;rounded=1;spacingLeft=8;spacingTop=4;" vertex="1" parent="1">
          <mxGeometry x="40" y="80" width="220" height="100" as="geometry"/>
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
